/bin/bash -e

# this is NOT ready to be run...
exit 0

img=first.img

mkdir vroot
sudo mount first.img -o loop,offset=$((512*131072)) vroot/
sudo mount first.img -o loop,offset=$((512*8192)) vroot/boot/

# remove ld.so.preload:
sudo mv vroot/etc/ld.so.preload vroot/etc/ld.so.preload.dist

# get statically linked version of qemu-arm installed in vroot (so we can emulate arm on x86).
sudo cp /usr/bin/qemu-arm-static vroot/usr/bin/

# do the chroot:
sudo chroot . bin/bash

[and we are IN!]
... follow raspi-install.txt
./provision.sh
exit
[ and we are OUT! ]

# move the ld.so.preload back:
mv  vroot/etc/ld.so.preload.dist vroot/etc/ld.so.preload
sudo umount vroot/boot
sudo umount vroot

And the img (first) is now a provisioned solo image.
